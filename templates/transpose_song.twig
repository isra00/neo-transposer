{% extends "base.twig" %}

{% block page_class %}transpose-song{% endblock %}

{% macro printTransposition(transposition, original_chords) -%}
	<table class="transposition">
		<thead>
			<tr><th {% if not transposition.getAsBook %}colspan="3"{% endif %}>
				{{ transposition.chordsForPrint[0]|raw }}
				<span class="capo">{{ transposition.capoForPrint }}</span>
				{% if app.debug -%}
				<small class="score">[{{ transposition.score|round }}]</small>
				{%- endif %}
			</th></tr>
		</thead>
		<tbody>
		{% for chord in original_chords if not transposition.getAsBook -%}
			<tr>
				<td class="original">{{ chord|raw }}</td>
				<td class="arrow center">&rarr;</td>
				<td class="transposed">{{ transposition.chordsForPrint[loop.index0]|raw }}</td>
			</tr>
		{%- else -%}
			<tr><td class="as-book">{% trans %}(same chords as in the book){% endtrans %}</td></tr>
		{%- endfor %}
		</tbody>
	</table>
{%- endmacro %}
{% import _self as self %}

{% block content %}

{% if not app.neouser.isLoggedIn %}
	{% import "login.twig" as login %}

	<div class="teaser">
		<div class="inside">
			<div class="more-inside">
				<p>{% trans with {'%song%': song.song.title } %}Neo-Transposer helps you to automatically transpose the chords of <strong>%song%</strong> so they match your voice. Type your e-mail, follow the steps and it will transpose all the songs of the Neocatechumenal Way for you!{% endtrans %}</p>
				{{ login.login_form('', app.request.getRequestUri) }}
			</div>
		</div>
	</div>
{% endif %}

<h1>
	{{ song.song.title }}
	<small>{% if app.debug %}[{{ song.song.idSong }}]{% endif %}</small>
</h1>

<p class="explanation">{% trans %}These two transpositions match your voice (they are equivalent). The first one has easier chords:{% endtrans %}</p>

<div class="transpositions-list">
{% for transposition in song.transpositions %}
	{{ self.printTransposition(transposition, song.song.originalChords) }}
{% endfor %}
</div>

{% if song.not_equivalent %}
{% set difference = (song.not_equivalent.deviationFromPerfect > 0) ? 'higher'|trans : 'lower'|trans %}
<p class="explanation">{% trans with {'%difference%': difference } %}This other transposition is a bit %difference%, but it has easier chords and may also fit your voice:{% endtrans %}</p>
<div class="transpositions-list">
	{{ self.printTransposition(song.not_equivalent, song.song.originalChords) }}
</div>
{% endif %}

<a name="feedback"></a>

{% if app.neouser.isLoggedIn %}

<form class="transposition-feedback" method="post" action="{{ path('transposition_feedback') }}">

	<input type="hidden" name="id_song" value="{{ song.song.idSong }}">

	<p class="answers" {% if non_js_fb %}style="display: none"{% endif %}>
		<button type="submit" name="worked" value="1" class="yes {% if feedback == 'yes' %}highlighted{% endif %}" id="feedback-yes" {% if feedback == 'yes' %}title="{% trans %}You have reported the proposed transposition as valid{% endtrans %}"{% endif %}>
			{% trans %}Yes{% endtrans %} {% if feedback == 'yes' %}&#10004;{% endif %}
			<small>{% trans %}It has worked{% endtrans %}</small>
		</button>
		<button type="submit" name="worked" value="0" class="no {% if feedback == 'no' %}highlighted{% endif %}" id="feedback-no">
			{% trans %}No{% endtrans %}
			<small>{% trans %}It hasn't worked{% endtrans %}</small>
		</button>
	</p>

	<div class="thanks {% if non_js_fb != 'yes' %}hidden{% endif %}" id="feedback-thanks">{% trans %}Happy to know that! :-){% endtrans %}</div>
	
	<ul id="reasons-no" class="{% if non_js_fb != 'no' %}hidden{% endif %}">
		{% if user_first_octave %}
		<li class="big">{% trans with {'%url%': url_wizard ~ "#afterNegativeFeedbackWithBadVoice"} %}It seems you have not measured your voice properly. Please, <a href="%url%">follow this instructions</a>.{% endtrans %}</li>
		{% else %}
		<li>{% trans with {'%url%': url_wizard ~ "#afterNegativeFeedback"} %}Maybe you didn't measure your voice properly. <a href="%url%">Click here to go to the Wizard</a>.{% endtrans %}</li>
		<li>{% trans %}Maybe you are not singing the song the same way it was analysed for the application{% endtrans %}</li>
		<li>{% trans %}Maybe you are not singing in the same tone as the guitar{% endtrans %}</li>
		{% endif %}
	</ul>
</form>
{% endif %}

<div class="your-voice">
	<em>{% trans %}Your voice:{% endtrans %}</em> {{ your_voice|raw }}
	<a href="{{ path('user_voice', {'_locale': app.locale, 'redirect': app.request.getRequestUri}) }}" class="small-button">{% trans %}Change{% endtrans %}</a>
</div>

<p class="tip">{% trans %}Beware that this is the best tone for your voice, but might not be the best one for the assembly.{% endtrans %}</p>

<p class="show-voice-chart">
	<a href="javascript:void(0)" class="btn-neutral" onclick="NT.showChart(this.parentNode)">{% trans %}Show voice chart{% endtrans %}</a>
</p>

<div id="voicechart-container">
	<table class="voicechart">
	{% for voice in voice_chart %}
		<tr class="{{ voice.css }}">
			<th>{{ voice.caption|trans }}</th>
			{% for i in range(0, voice.offset) %}<th>&nbsp;</th>{% endfor %}
			<td class="note">{{ voice.lowest }}</td>
			{% for i in range(0, voice.length) %}<td>██</td>{% endfor %}
			<td class="note">{{ voice.highest }}</td>
		</tr>
	{% endfor %}
	</table>
</div>

{% import 'base.twig' as self %}
{{ self.loadJsFramework() }}

<script>

NT = {

	showChart: function(oLinkContainer)
	{
		document.getElementById("voicechart-container").style.display = 'block';
		oLinkContainer.style.display = 'none';
		ga('send', 'event', 'Actions', 'ShowVoiceChart', '{{ song.song.title }}');
	},

	sendFeedback: function(iAnswer)
	{
		$.post(
			'{{ path('transposition_feedback') }}',
			{
				id_song: {{ song.song.idSong }},
				worked: iAnswer,
				referer: '{{ app.request.server.get('HTTP_REFERER') }}'
			}
		);
	}
};

$(function() {

	$("#feedback-yes").click(function(e) {
		e.preventDefault();
		$(".answers").hide();
		$("#feedback-thanks").show();
		NT.sendFeedback(1);
		ga('send', 'event', 'FeedbackTransposition', 'Worked', '{{ song.song.title }}');
	});

	$("#feedback-no").click(function(e) {
		e.preventDefault();
		$(".question").add(".answers").hide();
		$("#reasons-no").show();
		NT.sendFeedback(0);
		ga('send', 'event', 'FeedbackTransposition', 'NotWorked', '{{ song.song.title }}');
	});

});
</script>

{% endblock %}
